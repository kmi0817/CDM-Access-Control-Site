<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>CDM</title>

    <link rel="shortcut icon" href="data:image/x-icon" type="image/x-icon"> <!-- favicon 없을 때 에러 방지 코드 -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- <link rel="stylesheet" href="../static/upload.css" type="text/css"> -->

    <link rel="stylesheet" href="http://cdn.webix.com/edge/webix.css" type="text/css">
    <!-- <link rel="stylesheet" href="../static/webix.css" type="text/css"> -->

    <link rel="stylesheet" href="//cdn.webix.com/materialdesignicons/5.8.95/css/materialdesignicons.min.css"
        type="text/css" charset="utf-8">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>

</head>

<body>
    <script>
        webix.ready(() => {
            webix.ui({
                rows: [
                    {
                        view: "toolbar",
                        css: { "background-color": "lightgray" },
                        elements: [
                            {
                                view: "button", value: "IRB", width: 100, css: "webix_transparent webix_button",
                                click: () => { location.href = "/irb" },
                            },
                            {
                                view: "button", value: "Researcher", width: 100, css: "webix_transparent webix_button",
                                click: () => { location.href = "/researcher-irb" }
                            },
                            {
                                view: "button", value: "Provider", width: 100, css: "webix_transparent webix_button",
                                click: () => { location.href = "/provider" }
                            },
                            {
                                view: "button", value: "Consumer", width: 100, css: "webix_transparent webix_button",
                                click: () => { location.href = "/consumer" }
                            }
                        ]
                    },
                    {
                        view: "scrollview",
                        scroll: "auto",
                        body: {
                            rows: [
                                {
                                    view: "toolbar", height: 50,
                                    elements: [
                                        {
                                            view: "button", value: "Researcher", width: 100,
                                            click: () => { location.href = "/researcher-irb"; }
                                        },
                                        {
                                            align: "right", body: {
                                                cols: [
                                                    {
                                                        view: "button", value: "IRB connection", width: 200,
                                                        click: () => { location.href="/researcher-irb"; }
                                                    },
                                                    {
                                                        view: "button", value: "Provider connection", width: 200,
                                                        click: () => { location.href="/researcher-provider"; }
                                                    },
                                                    {
                                                        view: "button", value: "Consumer connection", width: 200,
                                                        click: () => { location.href="/researcher-consumer"; }
                                                    }
                                                ]
                                            }
                                        },
                                    ]
                                },
                                {
                                    view: "spacer", height: 30
                                },
                                {% if Provider_inv %}
                                {
                                    align: "center", body: {
                                        rows: [
                                            {
                                                template: "<h2>Provider connection</h2>", width: 700, autoheight: true
                                            },
                                            {
                                                view: "form", id: "credential_form", width: 700,
                                                elements: [
                                                    {
                                                        view: "textarea", readonly: true,
                                                        label: "DID", labelPosition: "top",
                                                        value: sessionStorage.getItem("provider_did"),
                                                        placeholder: "DID here"
                                                    },
                                                    {
                                                        view: "spacer", height: 20
                                                    },
                                                    {
                                                        view: "radio", id: "radio", vertical: true,
                                                        label: "Cred_ex_ids", labelPosition: "top",
                                                        // options: sessionStorage.getItem("cred_ex_ids")
                                                        options: ["9fc22e9c-e8e8-4c8b-8348-7944c75641e1","fc3c8edf-45ce-4980-b0f0-76caab149c60","6126b3c9-95d8-42cd-b3e2-9abce57ba807","de74c7dd-7956-40ac-b57d-aae87953dcfc","0bf89bd4-ff17-47a2-83f6-bcd1a67b7a8b","afaa55dd-2538-43d0-b474-93065e8705a9","6c1f9de4-2da7-42fd-a475-06c66424ae89","e048dbd7-3188-4fff-b173-3c37a36c1f71","41c33473-7503-45d9-95a4-f75c365c69b7","7df0f149-b1ae-4709-8805-d1b66b546cb1","ddb20e3c-6601-422d-9887-8c505c88e286","60f55095-2cee-4fd9-8d49-19a20b0e65ac"],
                                                        click: () => {
                                                            var selected = $$("radio").getValue();

                                                            webix.ajax().get(`http://0.0.0.0:8031/issue-credential-2.0/records/${selected}`)
                                                                .then((res) => {
                                                                    var result = res.json();
                                                                    result = result["cred_ex_record"]["cred_offer"]["credential_preview"];
                                                                    result = result["attributes"];
                                                                    
                                                                    $$("credential").setValue(JSON.stringify(result));
                                                                })
                                                                .fail((xhr) => {
                                                                    alert("해당 credential record를 가져올 수 없습니다.");
                                                                })
                                                        }
                                                    },
                                                    {
                                                        view: "spacer", height: 20
                                                    },
                                                    {
                                                        view: "textarea", id: "credential", readonly: true,
                                                        label: "Credential", labelPosition: "top",
                                                        height: 400, scroll: "y",
                                                        placeholder: "credentail here",
                                                    },
                                                    {
                                                        view: "spacer", height: 20
                                                    },
                                                    {
                                                        view: "button", value: "Present Credential",
                                                        click: () => {
                                                            var credential = $$("credential").getValue();

                                                            webix.ajax().post("/provider/receive-credential", JSON.stringify(credential))
                                                                .then((res) => {
                                                                    alert("Consumer에게 Credential을 제시했습니다. (따로 로컬 스토리지 세션 처리X swagger API도 사용X)\nProvider 페이지의 Data Selection 메뉴로 이동하세요.");
                                                                })
                                                                .fail((xhr) => {
                                                                    alert("Provider에게 Credential을 제시하는 데 실패했습니다.");
                                                                })
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                },
                                {% else %}
                                {
                                    align: "center", body: {
                                        rows: [
                                            {
                                                template: "<h2>Provider Invitation</h2>", width: 700, autoheight: true
                                            },
                                            {
                                                view: "form", id: "invitaion_form", width: 700,
                                                elements: [
                                                    {
                                                        view: "textarea", id: "invition", readonly: true,
                                                        autoheight: true, minHeight: 250,
                                                        placeholder: "Invition from Provider here",
                                                        value: sessionStorage.getItem("provider_invitation")
                                                    },
                                                    {
                                                        view: "button", value: "Accept Invitation",
                                                        click: () => {
                                                            var invitation = JSON.stringify(sessionStorage.getItem("provider_invitation"));
                                                            webix.ajax().post("http://0.0.0.0:8031/connections/receive-invitation", invitation)
                                                                .then((res) => {
                                                                    res = res.json();
                                                                    sessionStorage.setItem("provider_did", res.my_did);

                                                                    webix.ajax().get("http://0.0.0.0:8031/issue-credential-2.0/records")
                                                                        .then((res) => {
                                                                            const records = res.json()["results"]
                                                                            var cred_ex_ids_arr = new Array();
                                                                            records.forEach((item) => {
                                                                                cred_ex_ids_arr.push(item["cred_ex_record"]["cred_ex_id"]);
                                                                            });

                                                                            var cred_ex_ids = "[";
                                                                            cred_ex_ids_arr.forEach((item) => {
                                                                                cred_ex_ids += `"${item}",`;
                                                                            });
                                                                            
                                                                            cred_ex_ids = cred_ex_ids.slice(0, -1);
                                                                            cred_ex_ids += "]"
                                                                            sessionStorage.setItem("cred_ex_ids", cred_ex_ids);

                                                                            webix.ajax().post("/researcher-provider/accept-invitation", invitation)
                                                                                .then((res) => {
                                                                                    location.reload();
                                                                                })
                                                                                .fail((xhr) => {
                                                                                    alert("Provider의 초대장을 로컬 스토리지 세션에 등록하지 못하였습니다.");
                                                                                });
                                                                        })
                                                                        .fail((xhr) => {
                                                                            alert("wallet에서 credential records를 가져오는 데 실패했습니다.");
                                                                        });
                                                                })
                                                                .fail((xhr) => {
                                                                    alert("Researcher 서버 상태를 확인해주세요.");
                                                                });
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                },
                                {% endif %}
                                {
                                    view: "spacer", height: 30
                                }
                            ]
                        }
                    },
                ]
            });
        });
    </script>
</body>

</html>